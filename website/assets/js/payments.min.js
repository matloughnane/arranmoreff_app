
$( "#fname" ).change(function() {
  var textInput_fname = document.getElementById('fname').value;
  document.getElementById("fullName").innerHTML = textInput_fname;
});

var day_array = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var month_array = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// var ticket_desc = "Ticket Ferry Test";
var amount = "0.02";
var car_family_price = "€40.50"
var car_driver_price = "€27.00"
var adult_price = "€13.50"
var student_price = "€9.00"
var child_price = "€6.30"

var da_text = "Departing Arranmore"
var db_text = "Departing Burtonport"

// var formInput = "<form name='_xclick' action='https://www.paypal.com/uk/cgi-bin/webscr' method='post'> <input type='hidden' name='cmd' value='_xclick'> <input type='hidden' name='business' value='contact@matloughnane.com'> <input type='hidden' name='currency_code' value='GBP'> <input type='hidden' name='item_name' value='"+ticket_desc+"'> <input type='hidden' name='amount' value='"+amount+"'> <input type='image' src='http://www.paypal.com/en_GB/i/btn/x-click-but01.gif' border='0' name='submit' alt='Make payments with PayPal'> </form>";

$( "#ticket_desc" ).change(function() {
  var ticket_desc = document.getElementById('ticket_desc').value;
  var formGen = "<form name='_xclick' action='https://www.paypal.com/uk/cgi-bin/webscr' method='post'> <input type='hidden' name='cmd' value='_xclick'> <input type='hidden' name='business' value='contact@matloughnane.com'> <input type='hidden' name='currency_code' value='GBP'> <input type='hidden' name='item_name' value='"+ticket_desc+"'> <input type='hidden' name='amount' value='"+amount+"'> <input type='image' src='https://www.paypalobjects.com/webstatic/en_US/i/buttons/buy-logo-large.png' border='0' name='submit' alt='Make payments with PayPal'> </form>";
  document.getElementById("paypal_button").innerHTML = formGen;
});

// DISPLAY THE PRICE
$( "#ticketPicker" ).change(function() {
	var ticket_price = document.getElementById('ticketPicker').value;
	switch(ticket_price) {
	    case "car_family":
	        document.getElementById("price_grid").style.display = "block";
	        document.getElementById("ticket_price").innerHTML = car_family_price;
	        break;
	    case "car_driver":
	        document.getElementById("price_grid").style.display = "block";
	        document.getElementById("ticket_price").innerHTML = car_driver_price;
	        break;
	    case "adult":
	        document.getElementById("price_grid").style.display = "block";
	        document.getElementById("ticket_price").innerHTML = adult_price;
	        break;
	    case "student":
	        document.getElementById("price_grid").style.display = "block";
	        document.getElementById("ticket_price").innerHTML = student_price;
	        break;
	    case "child":
	        document.getElementById("price_grid").style.display = "block";
	        document.getElementById("ticket_price").innerHTML = child_price;
	        break;
	    default:
	    	console.log("none_selected");
	        document.getElementById("price_grid").style.display = "none";
	}
});

// CHANGE THE SECOND ROUTE CHOICE
$( "#journeyPicker" ).change(function() {
	var journey = document.getElementById('journeyPicker').value;
	if (journey == "da") {
		document.getElementById("return_journey").innerHTML = db_text;
	} else {
		document.getElementById("return_journey").innerHTML = da_text;
	}
});

// DISPLAY THE TIMES FOR DATE
$( "#first_sail_date" ).change(function() {
	var date_first_sail = document.getElementById('first_sail_date').value;
	var journey = document.getElementById('journeyPicker').value;
	getTimesForDate(date_first_sail, journey, "first_sail_times");
});

// DISPLAY THE TIMES FOR DATE
$( "#return_sail_date" ).change(function() {
	var date_first_sail = document.getElementById('return_sail_date').value;
	var journey = document.getElementById('journeyPicker').value;
	if (journey == "da") {
		journey = "db";
	} else {
		journey = "db";
	}
	console.log(journey);
	getTimesForDate(date_first_sail, journey, "return_sail_times");
});

// FIREBASE REF
var firebaseRef = new Firebase("https://amber-fire-55.firebaseio.com/timetable4/");

function getTimesForDate(date, journey, selectID) {
	var timetableObj = {};
	firebaseRef.on("value", function(snapshot) {
	    timetableObj = snapshot.val();
	    	var tdate = date;
		    var inputDate = getPrettyDate(date);
		    var todaysDate = checkDayRange(tdate);
		    var ttime = getPrettyTime(tdate);
		    var dayRange = todaysDate.substr(0, todaysDate.indexOf(','));
		    var monthRange = todaysDate.substr(todaysDate.lastIndexOf(',')+1, todaysDate.length);

		    var cancelledArray = checkCancelledFerries(timetableObj, journey, tdate);
		    var extraArray = checkExtraFerries(timetableObj, journey, tdate);

		    var finalArray = findDatabaseRef(timetableObj, journey, monthRange, dayRange, cancelledArray, extraArray);

		    constructSelect(finalArray, selectID);
		})
}
function constructSelect(array, selectID) {
	// console.log(array + " " + selectID);
	var selectHTML = "";
		for (i = 0; i < array.length; i++) {
			selectHTML += "<option value='"+array[i]+"'>"+array[i]+"</option>"
		};
	// console.log(selectHTML);
	document.getElementById(selectID).innerHTML = selectHTML;
};

function findDatabaseRef(timetableObj, journey, monthRange, dayRange, cancelledArray, extrasArray){
    // console.log(dayRange);
    for (key in timetableObj){
        if (key == journey){
            var journeyObj = timetableObj[key];
            // console.log(journeyObj);
            for (key in journeyObj){
                if (key == monthRange){
                    var monthObj = journeyObj[key];
                    // console.log(monthObj);
                    var exactDay = "";
                    for (key in monthObj){
                        if (dayRange == 'fri'){
                            dayRange = "wk";
                            exactDay = "fri";
                        } else if (dayRange == 'sat'){
                            dayRange = "wk";
                            exactDay = "sat";
                        }
                        if (key == dayRange) {
                            var timesObj = monthObj[key];
                            var array = [];
                            // console.log(array);
                            for (key in timesObj){
                                array.push(timesObj[key].time);
                            }

                            // FRIDAY FERRIES
                            if (exactDay == "fri"){
                                var dayObj = monthObj["fri"];
                                // console.log(dayObj);
                                if (dayObj == 'undefined'){
                                    // console.log("NOT A FRIDAY");
                                } else {
                                    // console.log("FRIDAY SELECTED");                                   
                                    for (key in dayObj){
                                        array.push(dayObj[key].time);
                                    }
                                }
                            }

                            // SATURDAY FERRIES 
                            if (exactDay == "sat"){
                                var dayObj = monthObj["sat"];
                                // console.log(dayObj);
                                if (dayObj == 'undefined'){
                                    // console.log("NOT A SATURDAY");
                                } else {
                                    // console.log("SATURDAY SELECTED");
                                    for (key in dayObj){
                                        array.push(dayObj[key].time);
                                    }
                                }
                            }

                            // console.log(array);

                            array.sort(function (a, b) {
                                return new Date('1970/01/01 ' + a) - new Date('1970/01/01 ' + b);
                            });
                            // console.log(array);
                            var arrayMinusCancel = compareCancelArrays(array, cancelledArray);
                            var finalArray = compareExtraArray(arrayMinusCancel, extrasArray);

                            finalArray.sort(function (a, b) {
                                return new Date('1970/01/01 ' + a) - new Date('1970/01/01 ' + b);
                            });

                            // console.log(finalArray);
                            return finalArray;
                        }
                    }
                }
            }
        }
    };
};

function checkCancelledFerries(timetableObj, journey, date){
	// console.log(journey);
    if (journey == "da"){
        var cancelFerryObj = timetableObj.cancel_ferry.da;
    } else {
        var cancelFerryObj = timetableObj.cancel_ferry.db;
    }
    var array = [];
    for (key in cancelFerryObj){
        if (date == cancelFerryObj[key].date){
            array.push(cancelFerryObj[key].time);
        }
    }
    return array;
};
function checkExtraFerries(timetableObj, journey, date){
    if (journey == "da"){
        var extraFerryObj = timetableObj.extra_ferry.da;
    } else {
        var extraFerryObj = timetableObj.extra_ferry.db;
    }

    var array = [];
    for (key in extraFerryObj){

        var uglyDate = getInputDate(extraFerryObj[key].date);
        // console.log(uglyDate);
        if (getInputDate(date) == uglyDate){
            array.push(extraFerryObj[key].time);
        };
    };

    return array;
};
function compareExtraArray(totalArray, extrasArray){
    var array = totalArray;
    for (var i = 0; i < extrasArray.length; i++){
        array.push(extrasArray[i]);
    }
    return array;
};
function compareCancelArrays(array, cancelledArray){
    for (var i = 0; i < cancelledArray.length ; i ++) {
        for (var j = 0; j < array.length ; j ++){
            if (cancelledArray[i] == array[j]){
                var removeIndex = array.indexOf(array[j]);
                array.splice(removeIndex, 1);
            }
        };
    };
    return array;
};
function checkDayRange(date){
    var cDate = getPrettyDate(date);
    var day = cDate.substr(0, cDate.indexOf(','));
    // console.log(day);
    var cdate = new Date(date);
    var cyear = cdate.getYear();
    if (cyear < 1900){ cyear = cyear + 1900};
    var cmonth = cdate.getMonth()+1;
    // console.log(cmonth);
    var cdate = cdate.getDate();

    if (day == "Sun" || day == "Domh"){
        var dayRange = "sun";
    } else if (day == "Fri" || day == "Aoine") {
        var dayRange = "fri";
    } else if (day == "Sat" || day == "Sath") {
        var dayRange = "sat";
    } else {
        var dayRange = "wk";
    }

    if (cmonth < 5) {
        var monthRange = "jantoapr";
    } else if (cmonth == 5){
        var monthRange = "may";
    } else if (cmonth > 5 && cmonth < 9) {
        var monthRange = "juntoaug";
    } else if (cmonth > 8 && cmonth < 11) {
        var monthRange = "septooct";
    } else if (cmonth > 10) {
        var monthRange = "novtodec";
    }

    return (dayRange+","+monthRange);
};
function getPrettyTime(date){ 
    var rawDate = new Date(date);

    var hours = lessThanTen(rawDate.getHours());
    var minutes = lessThanTen(rawDate.getMinutes());
    var seconds = lessThanTen(rawDate.getSeconds());

    var time = "" + hours + ":"  
                + minutes + "";
    return time; 
}
function lessThanTen(number) {
    if (number < 10) {
        var newNumber = "0"+number;
    } else {
        var newNumber = number;
    };
    return newNumber;
};
function getPrettyDate(date){
    // CREATE THE CHECK DATE IN CORRECT FORMAT
    var cdate = new Date(date);
    var year = cdate.getYear();
    var month_num = cdate.getMonth()+1;
    var date = cdate.getDate();
    var day_num = cdate.getDay();

    if (year < 1000) { year += 1900 };
    if (date < 9) { date = "0"+date };

    // CHECK THE DATE AGAINST THE TIMETABLE OBJ
    var prettyDate = day_array[day_num] + ", " + date + " " + month_array[month_num-1] + " " + year;
    // console.log(prettyDate);
    return prettyDate;
};
function getInputDate(date){
    // CREATE THE CHECK DATE IN CORRECT FORMAT
    var cdate = new Date(date);
    // console.log(cdate);
    var yearToCheck = cdate.getYear();
    var monthToCheck = cdate.getMonth()+1;
    var dateToCheck = cdate.getDate();

    if (yearToCheck < 1000) { yearToCheck += 1900 };
    if (monthToCheck <= 9) { monthToCheck = "0"+monthToCheck };
    if (dateToCheck <= 9) { dateToCheck = "0"+dateToCheck };

    // CHECK THE DATE AGAINST THE TIMETABLE OBJ
    var checkDate = yearToCheck+"-"+monthToCheck+"-"+dateToCheck;
    return checkDate;
}
